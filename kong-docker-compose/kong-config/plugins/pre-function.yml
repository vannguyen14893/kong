#  - name: pre-function
#    route: ms-inventory-route
#    config:
#      access:
#        - |
#          -- Extract JWT token từ header
#          local token = kong.request.get_header("authorization")
#          if token then
#            token = token:match("Bearer%s+(.+)")
#          end
#
#          if token then
#            -- Forward token đến upstream service
#            kong.service.request.set_header("X-JWT-Token", token)
#
#            -- Basic claim extraction without external libraries
#            -- Chỉ extract các claims đơn giản từ payload
#            local parts = {}
#            for part in token:gmatch("[^%.]+") do
#              table.insert(parts, part)
#            end
#
#            if #parts >= 2 then
#              local payload = parts[2]
#              -- Base64 decode
#              local missing_padding = #payload % 4
#              if missing_padding > 0 then
#                payload = payload .. string.rep("=", 4 - missing_padding)
#              end
#
#              local ok, decoded = pcall(function()
#                return require("ngx.base64").decode_base64url(payload)
#              end)
#
#              if ok and decoded then
#                -- Parse JSON claims
#                local claims, err = kong.json.decode(decoded)
#                if claims then
#                  if claims.sub then
#                    kong.service.request.set_header("X-User-ID", claims.sub)
#                  end
#                  if claims.roles then
#                    kong.service.request.set_header("X-User-Roles", type(claims.roles) == "table" and table.concat(claims.roles, ",") or tostring(claims.roles))
#                  end
#                  if claims.email then
#                    kong.service.request.set_header("X-User-Email", claims.email)
#                  end
#                end
#              end
#            end
#          end